---
title: "Untitled"
author: "Eliza"
date: "5 april 2018"
output: html_document
---

#```{r}
#library(ggplot2)
#library(tidyr)

#train = read.csv("train.csv")
#test = read.csv("test.csv")
##View(train)
#
#attach(train)
#
#```
#
#
#
## Analyze data
#
#``` {r}
## Only 38 % survived in train set
#prop.table(table(Survived))
#
## Most females survived, most males died
#prop.table(table(Survived,Sex),2)
#
## Passengers embarking at SoutHampton and Queenstown more likely to die. Embarking at Cherbourg more likely to survive. 
#prop.table(table(Survived[Embarked!=""], Embarked[Embarked!=""]),2)
#
## Passengers with a few (1-3) relatives (siblings, spouses, parents, children) more likely to survive. Solo travelers more likely to die
#prop.table(table(Survived,SibSp+Parch),2)
#
#
#```

# Predict that all females survive and all males die. 76% accuracy. Use as baseline
#``` {r}
# All females survive, all males die - 76% test accuracy according to Kaggle
test$Survived = rep(0,418)
test$Survived[test$Sex=="female"] = 1
submit_sex = data.frame(PassengerId = test$PassengerId, Survived = test$Survived)
write.csv(submit_sex, file = "submit_sex.csv", row.names = FALSE)

```
#
## Predict that people with 2-3 relatives survive. Only 61% 
#``` {r}
#test$Relatives = test$SibSp + test$Parch
#test$Survived = rep(0,418)
#test$Survived[test$Relatives == (2 || 3)] = 1
#submit_rel = data.frame(PassengerId = test$PassengerId, Survived= test$Survived)
#write.csv(submit_rel, file = "submit_rel.csv", row.names = FALSE)
#
#```
#
#
## Create age groups for passengers - child, adult and elderly
#``` {r}
#summary(Age)
## 177 NA's. Fill in with mean of sex
#Age[is.na(Age) & Sex=="female"] = mean(Age[Sex=="female"], na.rm=TRUE)
#Age[is.na(Age) & Sex=="male"] = mean(Age[Sex=="male"], na.rm=TRUE)
#summary(Age)
#
#train$AgeGrp = rep("Adult",dim(train)[1])
#train$AgeGrp[Age<18] = "Child"
#train$AgeGrp[Age>=65] = "Elderly"
#train$AgeGrp = as.factor(train$AgeGrp)
#
## Do the same for test data
#test$Age[is.na(test$Age) & test$Sex=="female"] = mean(test$Age[Sex=="female"], na.rm=TRUE)
#test$Age[is.na(test$Age) & test$Sex=="male"] = mean(test$Age[Sex=="male"], na.rm=TRUE)
#
#test$AgeGrp = rep("Adult",dim(test)[1])
#test$AgeGrp[test$Age<18] = "Child"
#test$AgeGrp[test$Age>=65] = "Elderly"
#test$AgeGrp = as.factor(test$AgeGrp)
#
#
#table(Survived, train$AgeGrp, Sex)
## probability of surviving based on age group and sex
#aggregate(Survived ~ AgeGrp + Sex, data=train, FUN=function(x) {sum(x)/length(x)})
## females more likely to survive for all age groups. Males more likely to die, especially if elderly.
#
#
#```

# Survival based on age group and number of parents/children and siblings/spouses
Children with 1-2 Parch, 0-1 SibSp or 1 Parch + 2 SibSp likely to survive.
Adults with 1-3 Parch + 0/2 SibSp, 0-3 Parch + 1 SibSp, 0/2 Parch + 3 SibSp likely to survive. 
Elderly likely to die.
``` {r}

agg = aggregate(Survived ~ Parch + SibSp + AgeGrp, data=train, FUN=function(x) {sum(x)/length(x)})
agg = do.call(data.frame, agg[agg$Survived>=0.5,])

test$Survived = rep(0, 418)
for( i in 1:dim(agg)[1]) {
  test$Survived[test$Parch == agg$Parch[i] & test$SibSp == agg$SibSp[i] & test$AgeGrp == agg$AgeGrp[i]] = 1
}

submit_rel_age = data.frame(PassengerId = test$PassengerId, Survived = test$Survived)
write.csv(submit_rel_age, file = "submit_rel_age.csv", row.names = FALSE)
```

# Add sex to survival likelihood. Accuracy increased to 0.78!
``` {r} 

agg = aggregate(Survived ~ Parch + SibSp + AgeGrp + Sex, data=train, FUN=function(x) {sum(x)/length(x)})
agg = do.call(data.frame, agg[agg$Survived>=0.5,])

test$Survived = rep(0, 418)
for( i in 1:dim(agg)[1]) {
  test$Survived[test$Parch == agg$Parch[i] & test$SibSp == agg$SibSp[i] & test$AgeGrp == agg$AgeGrp[i] & test$Sex == agg$Sex[i]] = 1
}

submit_rel_age_sex = data.frame(PassengerId = test$PassengerId, Survived = test$Survived)
write.csv(submit_rel_age_sex, file = "submit_rel_age_sex.csv", row.names = FALSE)

```

# Instead of relatives, look at economic status
``` {r}

summary(Fare)


aggregate(Survived ~ Pclass + AgeGrp + Sex, data=train, FUN=function(x) {sum(x)/length(x)})
agg = do.call(data.frame, agg[agg$Survived>=0.5,])

```
# Classification trees
``` {r}
library(rpart)
library(rpart.plot)
library(rattle)
library(RColorBrewer)

tree = rpart(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked, data=train, method="class")
summary(tree)

plot(tree) 
text(tree, use.n=TRUE, all=TRUE, cex=.8)

#fancyRpartPlot(tree)
#
#```
#
#
#``` {r}
#
#tree = rpart(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked + CabinGrp, data=train, method="class")
#
#tree = prune(tree, cp = tree$cptable[which.min(tree$cptable[,"xerror"]),"CP"])
#fancyRpartPlot(tree)
#
#test$CabinGrp = as.factor(substring(test$Cabin, 1, 1))
#
#test$Survived = predict(tree, test, type="class")
#test$Survived = as.numeric(levels(test$Survived))[test$Survived]
#
#submit_tree1 = data.frame(PassengerId = test$PassengerId, Survived = test$Survived)
#write.csv(submit_tree1, file = "submit_tree1.csv", row.names = FALSE)
#```
```
# Feature engineering - code starts here!
# ALEX do visualization
``` {r}
library(rpart)
library(rpart.plot)
library(rattle)
library(RColorBrewer)

train = read.csv("train.csv")
test = read.csv("test.csv")


# combine train and test data
test$Survived = rep(NA,418)
alldata = rbind(train, test)
attach(alldata)

# create decks
alldata$Deck = substring(Cabin, 1, 1)
alldata$Deck[alldata$Deck==""] = "U" #unknown
alldata$Deck = as.factor(alldata$Deck)



Title = sapply(Name, FUN = function(x) {strsplit(as.character(x), split='[,.]')[[1]][2]})
Title = substring(Title, 2)
alldata$Title = Title




# group titles together
#alldata$Title[alldata$Title %in% c("Capt", "Sir", "Don", "Major")] = "Sir"
#alldata$Title[alldata$Title %in% c("the Countess", "Jonkheer", "Lady", "Dona")] = "Lady"

# group titles together
alldata$Title[alldata$Title %in% c("Dr", "Capt", "Sir", "Don", "Major", "Jonkheer")] = "Sir"
alldata$Title[alldata$Title %in% c("the Countess", "Lady", "Dona")] = "Lady"
alldata$Title[alldata$Title=="Mlle" | alldata$Title=="Ms"] = "Miss"
alldata$Title[alldata$Title=="Mme"] = "Mrs"
alldata$Title = as.factor(alldata$Title)



ggplot(data = alldata,aes(x=as.factor(alldata$Survived), fill=alldata$Title)) + geom_bar(stat="count") 

#alldata$FamSize = as.factor(alldata$SibSp + alldata$Parch)
alldata$FamSize = alldata$SibSp + alldata$Parch

# Fare previous for the whole ticket. Divide it by number of passengers per ticket to get fare per passenger. 
# Travel size defined by number of passengers sharing same ticket number. Similar to FamSize but takes friend groups into account
alldata$FareAdj = rep("", dim(alldata)[1])
alldata$TravelSize = (rep(1, dim(alldata)[1]))
for(ticnr in levels(Ticket)) {
  alldata$FareAdj[alldata$Ticket==ticnr] = signif(alldata$Fare[(alldata$Ticket==ticnr)]/sum(alldata$Ticket==ticnr),4)
  alldata$TravelSize[(alldata$Ticket==ticnr)] =(sum(alldata$Ticket==ticnr))
}
#alldata$TravelSize = as.factor(alldata$TravelSize)
alldata$FareAdj = as.numeric(alldata$FareAdj)
# Deal with missing values
summary(alldata)
# One NA fare
# Regression tree
FareFit = rpart(Fare ~ Sex + Pclass + Title + Deck + Embarked + TravelSize + FamSize, data=alldata[!is.na(alldata$Fare),], method="anova")
alldata$Fare[is.na(alldata$Fare)] = predict(FareFit, newdata=alldata[is.na(alldata$Fare),])
alldata$FareAdj[is.na(alldata$FareAdj)] = alldata$Fare[is.na(alldata$FareAdj)]/sum(alldata$Ticket == alldata$Ticket[is.na(alldata$FareAdj)])

# 263 NA ages
AgeFit = randomForest(Age ~ FareAdj + Title + FamSize, data=alldata[!is.na(alldata$Age),], importance=TRUE, ntrees=500)
alldata$Age[is.na(alldata$Age)] = round(predict(AgeFit, newdata=alldata[is.na(alldata$Age),]))

trainAdj = alldata[!is.na(Survived), c("Survived", "Pclass", "Sex", "Age","Embarked", "Deck", "Title", "FamSize", "FareAdj", "TravelSize")]
testAdj = alldata[is.na(Survived), c("Survived", "Pclass", "Sex", "Age","Embarked", "Deck", "Title", "FamSize", "FareAdj", "TravelSize")]


# double check cross validation for age prediction features ALEX - and check whether features correct
#rfcv(trainAdj[], alldata$Age[!is.na(alldata$Age)], cv.fold=10)

alldata$Age[is.na(alldata$Age)] = predict(AgeFit, newdata=alldata[is.na(alldata$Age),])
varImpPlot(AgeFit)

```

```{r}



# 2 missing embarkation ports
EmbarkedFit = rpart(Embarked ~ Sex + FareAdj + Pclass + Title + Deck + Age + FamSize + TravelSize, data=alldata[alldata$Embarked!="",], method="class", maxdepth=3) # decision tree with max depth of 3 to prevent overfitting
# Only FareAdj relevant (variable importance=49)
#fancyRpartPlot(EmbarkedFit)
alldata$Embarked[which(alldata$Embarked=="")] = predict(EmbarkedFit, newdata=alldata[alldata$Embarked=="",], type="class")

trainAdj = alldata[!is.na(Survived), c("Survived", "Pclass", "Sex", "Age","Embarked", "Deck", "Title", "FamSize", "FareAdj", "TravelSize")]
testAdj = alldata[is.na(Survived), c("Survived", "Pclass", "Sex", "Age","Embarked", "Deck", "Title", "FamSize", "FareAdj", "TravelSize")]

```




``` {r}
SurvivedFit = rpart(as.factor(Survived) ~ ., data = trainAdj, method="class")
fancyRpartPlot(SurvivedFit)
summary(SurvivedFit)
SurvivedFit$variable.importance

pred = predict(SurvivedFit, newdata=testAdj)
submit_tree2 = data.frame(PassengerId = rownames(testAdj), Survived = pred)
write.csv(submit_tree2, "submit_tree2.csv", row.names = FALSE)

# Best with 0.78947 accuracy

```

``` {r}
library(randomForest)
set.seed(100)

ForestFit = randomForest(as.factor(Survived) ~ Title + FareAdj, data=trainAdj, importance=TRUE, ntree=5000)
varImpPlot(ForestFit)

pred = predict(ForestFit, newdata = testAdj)
submit_forest4 = data.frame(passengerId = rownames(testAdj), Survived = pred)
write.csv(submit_forest4, "submit_forest4.csv", row.names=FALSE)

# Only 0.755598 accuracy

```

``` {r}
library(party)
set.seed(100)
cForestFit = cforest(as.factor(Survived) ~ ., data=trainAdj, controls = cforest_control(ntree=5000, mtry = 9))

pred = predict(cForestFit, testAdj, OOB=TRUE, type="response")

submit_forest2 = data.frame(PassengerId = rownames(testAdj), Survived = pred)
#write.csv(submit_forest2, "submit_forest2.csv", row.names=FALSE)

# 0.79425 best so far

```

``` {r}
library(gbm)
set.seed(100)
gbm1 = gbm(Survived ??? . , data=trainAdj, distribution="bernoulli", n.trees=10000, cv.folds=5, interaction.depth=4)
best.iter = gbm.perf(gbm1,method="cv")
summary(gbm1, n.trees=best.iter)

pred_boost1 = predict(gbm1, newdata=testAdj, n.trees=best.iter, type="response")
pred_boost1 = round(pred_boost1)

submit_boost1 = data.frame(PassengerId=rownames(testAdj), Survived=pred_boost1)
write.csv(submit_boost1, "submit_boost1.csv", row.names=FALSE)

```


``` {r}
glmFit = glm(Survived ~ ., data=trainAdj, family=binomial)
summary(glmFit)
glmFit = glm(Survived ~ PClass + Age + FamSize, data=trainAdj, family=binomial)

```